trigger:
- main

pool:
  vmImage: windows-latest

variables:
- group: vg-iac

stages:
# -------------------------
# Stage 1: Validate + Plan
# -------------------------
- stage: PLAN
  displayName: "Terraform PLAN"
  jobs:
  - job: PlanJob
    displayName: "Format, Validate, Plan"
    steps:
    - checkout: self

    - powershell: |
        choco install terraform -y
        terraform -version
      displayName: "Install Terraform"

    - task: AzureCLI@2
      displayName: "Terraform Init (Remote State)"
      inputs:
        azureSubscription: "SC-Azure-Terraform426-16"
        scriptType: "ps"
        scriptLocation: "inlineScript"
        inlineScript: |
          terraform init `
            -backend-config="resource_group_name=$(TFSTATE_RG)" `
            -backend-config="storage_account_name=$(TFSTATE_STORAGE)" `
            -backend-config="container_name=$(TFSTATE_CONTAINER)" `
            -backend-config="key=$(TFSTATE_KEY)"

    - powershell: |
        terraform fmt -check
      displayName: "Terraform fmt (check)"

    - powershell: |
        terraform validate
      displayName: "Terraform validate"

    - task: AzureCLI@2
      displayName: "Terraform import RG and SA if exists"
      inputs:
        azureSubscription: "SC-Azure-Terraform426-16"
        scriptType: "ps"
        scriptLocation: "inlineScript"
        inlineScript: |
          $rgName = "$(TF_RG_NAME)".Trim()
          $saName = "$(TF_SA_NAME)".Trim()
          $location = "$(TF_LOCATION)".Trim()
          $containerName = "$(TF_CONTAINER_NAME)".Trim()
          $env = "$(TF_ENV)".Trim()
          
          # Check if RG exists in Azure
          $exists = az group exists --name $rgName
          if ($exists -eq "true") {
            $subId = az account show --query id -o tsv
            Write-Host "RG '$rgName' exists. Checking if already in Terraform state..."
            
            # Check if RG resource already exists in state
            & { terraform state show azurerm_resource_group.rg 2>&1 | Out-Null }
            $rgExists = $?
            if ($rgExists) {
              Write-Host "RG already managed by Terraform. Skipping import."
            }
            else {
              Write-Host "Importing RG into Terraform state..."
              terraform import -lock=false -input=false `
                -var="location=$location" `
                -var="rg_name=$rgName" `
                -var="storage_account_name=$saName" `
                -var="container_name=$containerName" `
                -var="env=$env" `
                azurerm_resource_group.rg "/subscriptions/$subId/resourceGroups/$rgName"
              if ($LASTEXITCODE -ne 0) {
                Write-Host "RG import failed with exit code $LASTEXITCODE"
                exit 1
              }
            }
          }
          else {
            Write-Host "RG '$rgName' does not exist. Terraform will create it."
          }
          
          # Check if Storage Account exists in Azure
          $saExists = az storage account show --name $saName --resource-group $rgName 2>$null
          if ($saExists) {
            Write-Host "Storage Account '$saName' exists. Checking if already in Terraform state..."
            
            # Check if SA resource already exists in state
            $saInState = $false
            try {
              terraform state show azurerm_storage_account.sa *>$null
              $saInState = $true
            }
            catch {
              $saInState = $false
            }
            
            if ($saInState) {
              Write-Host "Storage Account already managed by Terraform. Skipping import."
            }
            else {
              Write-Host "Importing Storage Account into Terraform state..."
              $saId = "/subscriptions/$subId/resourceGroups/$rgName/providers/Microsoft.Storage/storageAccounts/$saName"
              terraform import -lock=false -input=false `
                -var="location=$location" `
                -var="rg_name=$rgName" `
                -var="storage_account_name=$saName" `
                -var="container_name=$containerName" `
                -var="env=$env" `
                azurerm_storage_account.sa "$saId"
              if ($LASTEXITCODE -ne 0) {
                Write-Host "Storage Account import failed with exit code $LASTEXITCODE"
                exit 1
              }
            }
          }
          else {
            Write-Host "Storage Account '$saName' does not exist. Terraform will create it."
          }

    - task: AzureCLI@2
      displayName: "Terraform plan"
      inputs:
        azureSubscription: "SC-Azure-Terraform426-16"
        scriptType: "ps"
        scriptLocation: "inlineScript"
        inlineScript: |
          $location = "$(TF_LOCATION)".Trim()
          $rgName = "$(TF_RG_NAME)".Trim()
          $saName = "$(TF_SA_NAME)".Trim()
          $containerName = "$(TF_CONTAINER_NAME)".Trim()
          $env = "$(TF_ENV)".Trim()
          
          terraform plan `
            -out=tfplan `
            -var="location=$location" `
            -var="rg_name=$rgName" `
            -var="storage_account_name=$saName" `
            -var="container_name=$containerName" `
            -var="env=$env"

    - publish: tfplan
      artifact: tfplan
      displayName: "Publish tfplan artifact"


# -------------------------
# Stage 2: Apply (Approval)
# -------------------------
- stage: APPLY
  displayName: "Terraform APPLY (Approval)"
  dependsOn: PLAN
  condition: succeeded()
  jobs:
  - deployment: ApplyDeployment
    displayName: "Apply Terraform"
    environment: "prod"
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - powershell: |
              choco install terraform -y
              terraform -version
            displayName: "Install Terraform"

          - download: current
            artifact: tfplan
            displayName: "Download tfplan artifact"

          - task: AzureCLI@2
            displayName: "Terraform Init (Remote State)"
            inputs:
              azureSubscription: "SC-Azure-Terraform426-16"
              scriptType: "ps"
              scriptLocation: "inlineScript"
              inlineScript: |
                $tfstateRg = "$(TFSTATE_RG)".Trim()
                $tfstateStorage = "$(TFSTATE_STORAGE)".Trim()
                $tfstateContainer = "$(TFSTATE_CONTAINER)".Trim()
                $tfstateKey = "$(TFSTATE_KEY)".Trim()
                
                terraform init `
                  -backend-config="resource_group_name=$tfstateRg" `
                  -backend-config="storage_account_name=$tfstateStorage" `
                  -backend-config="container_name=$tfstateContainer" `
                  -backend-config="key=$tfstateKey"

          - task: AzureCLI@2
            displayName: "Terraform apply (from plan)"
            inputs:
              azureSubscription: "SC-Azure-Terraform426-16"
              scriptType: "ps"
              scriptLocation: "inlineScript"
              inlineScript: |
                $tfplanPath = "$(Pipeline.Workspace)/tfplan"
                if (-Not (Test-Path $tfplanPath)) {
                  Write-Host "ERROR: tfplan file not found at $tfplanPath"
                  exit 1
                }
                terraform apply -auto-approve "$tfplanPath"
